apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

/**
 * This is the configuration block to customize your React Native Android app.
 * By default you don't need to apply any configuration, just uncomment the lines you need.
 */
react {
    /* Folders */
    //   The root of your project, i.e. where "package.json" lives. Default is '..'
    // root = file("../")
    //   The folder where the react-native NPM package is. Default is ../node_modules/react-native
    // reactNativeDir = file("../node_modules/react-native")
    //   The folder where the react-native Codegen package is. Default is ../node_modules/@react-native/codegen
    // codegenDir = file("../node_modules/@react-native/codegen")
    //   The cli.js file which is the React Native CLI entrypoint. Default is ../node_modules/react-native/cli.js
    // cliFile = file("../node_modules/react-native/cli.js")

    /* Variants */
    //   The list of variants to that are debuggable. For those we're going to
    //   skip the bundling of the JS bundle and the assets. By default is just 'debug'.
    //   If you add flavors like lite, prod, etc. you'll have to list your debuggableVariants.
    // debuggableVariants = ["liteDebug", "prodDebug"]

    /* Bundling */
    //   A list containing the node command and its flags. Default is just 'node'.
    // nodeExecutableAndArgs = ["node"]
    //
    //   The command to run when bundling. By default is 'bundle'
    // bundleCommand = "ram-bundle"
    //
    //   The path to the CLI configuration file. Default is empty.
    // bundleConfig = file(../rn-cli.config.js)
    //
    //   The name of the generated asset file containing your JS bundle
    // bundleAssetName = "MyApplication.android.bundle"
    //
    //   The entry file for bundle generation. Default is 'index.android.js' or 'index.js'
    // entryFile = file("../js/MyApplication.android.js")
    //
    //   A list of extra flags to pass to the 'bundle' commands.
    //   See https://github.com/react-native-community/cli/blob/main/docs/commands.md#bundle
    // extraPackagerArgs = []

    /* Hermes Commands */
    //   The hermes compiler command to run. By default it is 'hermesc'
    // hermesCommand = "$rootDir/my-custom-hermesc/bin/hermesc"
    //
    //   The list of flags to pass to the Hermes compiler. By default is "-O", "-output-source-map"
    // hermesFlags = ["-O", "-output-source-map"]
}

/**
 * Set this to true to Run Proguard on Release builds to minify the Java bytecode.
 */
def enableProguardInReleaseBuilds = false

/**
 * The preferred build flavor of JavaScriptCore (JSC)
 *
 * For example, to use the international variant, you can use:
 * `def jscFlavor = 'org.webkit:android-jsc-intl:+'`
 *
 * The international variant includes ICU i18n library and necessary data
 * allowing to use e.g. `Date.toLocaleString` and `String.localeCompare` that
 * give correct results when using with locales other than en-US. Note that
 * this variant is about 6MiB larger per architecture than default.
 */
def jscFlavor = 'org.webkit:android-jsc:+'

// Copia ícones de radar de assets/images para res/drawable (nativo Mapbox usa getIdentifier)
def radarAssetsDir = file("${project.rootProject.projectDir.parent}/assets/images")
def drawableDir = file("${project.projectDir}/src/main/res/drawable")
task copyRadarIconsToDrawable {
    doLast {
        if (!radarAssetsDir.exists()) {
            println "copyRadarIconsToDrawable: assets/images não encontrado, ignorando."
            return
        }
        drawableDir.mkdirs()
        // Android: nomes de drawable devem ser apenas a-z, 0-9, underscore (sem maiúsculas)
        // Mapeamento: arquivo fonte -> nomes drawable (snake_case apenas)
        def radarFiles = [
            "radarMovel.png": ["assets_images_radar_movel"],
            "radarSemaforico.png": ["assets_images_radar_semaforico"],
            "placa60.png": ["assets_images_radar_fixo"],
        ]
        // Remover arquivos com nomes inválidos (camelCase) se existirem
        ["assets_images_radarFixo", "assets_images_radarMovel", "assets_images_radarSemaforico"].each { invalid ->
            def bad = new File(drawableDir, "${invalid}.png")
            if (bad.exists()) {
                bad.delete()
                println "  Removido ${invalid}.png (nome inválido para Android)"
            }
        }
        // Placas: placa0 e placa10 têm arquivos próprios; se não existirem, usa placa20 como fallback
        for (int i = 0; i <= 160; i += 10) {
            def f = new File(radarAssetsDir, "placa${i}.png")
            if (!f.exists() && i < 20) f = new File(radarAssetsDir, "placa20.png")
            if (f.exists()) {
                def name = "assets_images_placa${i}"
                def dest = new File(drawableDir, "${name}.png")
                if (!dest.exists() || f.lastModified() > dest.lastModified()) {
                    java.nio.file.Files.copy(f.toPath(), dest.toPath(), java.nio.file.StandardCopyOption.REPLACE_EXISTING)
                    println "  Copiado ${f.name} -> ${name}.png"
                }
            }
        }
        radarFiles.each { sourceName, destNames ->
            def src = new File(radarAssetsDir, sourceName)
            if (src.exists()) {
                destNames.each { baseName ->
                    def dest = new File(drawableDir, "${baseName}.png")
                    if (!dest.exists() || src.lastModified() > dest.lastModified()) {
                        java.nio.file.Files.copy(src.toPath(), dest.toPath(), java.nio.file.StandardCopyOption.REPLACE_EXISTING)
                        println "  Copiado ${sourceName} -> ${baseName}.png"
                    }
                }
            }
        }
        println "copyRadarIconsToDrawable concluído."
    }
}

// Task para aplicar patch ANTES do build - APENAS SE O ARQUIVO FOI MODIFICADO
// Desabilitado para permitir edições manuais sem reversão
task applyPatch {
    enabled = false // Desabilitado - patch será aplicado manualmente quando necessário
    doFirst {
        println "============================================"
        println "APLICANDO PATCH DO MAPBOX NAVIGATION..."
        println "============================================"
    }
    doLast {
        def rootDir = rootProject.projectDir.parentFile
        def isWindows = System.getProperty('os.name').toLowerCase().contains('windows')
        
        // Limpar build antes de aplicar patch
        def buildDir = new File(rootDir, "node_modules/@pawan-pk/react-native-mapbox-navigation/android/build")
        if (buildDir.exists()) {
            println "Limpando build antigo..."
            buildDir.deleteDir()
        }
        
        try {
            exec {
                workingDir rootDir
                if (isWindows) {
                    commandLine 'cmd', '/c', 'npx.cmd', 'patch-package', '@pawan-pk/react-native-mapbox-navigation', '--use-yarn=false'
                } else {
                    commandLine 'npx', 'patch-package', '@pawan-pk/react-native-mapbox-navigation', '--use-yarn=false'
                }
            }
            println "Patch aplicado com sucesso!"
        } catch (Exception e) {
            println "ERRO: Falha ao aplicar patch!"
            println "Execute manualmente: npx patch-package @pawan-pk/react-native-mapbox-navigation"
            // NÃO FALHAR o build - apenas avisar
            println "AVISO: Continuando build sem aplicar patch..."
        }
    }
}

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "radarbot"
    defaultConfig {
        applicationId "com.radarbot"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
        // buildConfigField String precisa ser uma string Java válida (com aspas)
        buildConfigField "String", "MAPBOX_ACCESS_TOKEN", "\"pk.eyJ1Ijoia2VpbGxvbiIsImEiOiJjbWpld2g0dnkwN3FyM2txMTY4aGN3aTlvIn0.CwcSIMVWiMyt_z9tRwi6WQ\""
        // Recurso exigido pelo Mapbox (lido automaticamente pelo SDK se MapboxOptions.accessToken não estiver setado)
        resValue "string", "mapbox_access_token", "pk.eyJ1Ijoia2VpbGxvbiIsImEiOiJjbWpld2g0dnkwN3FyM2txMTY4aGN3aTlvIn0.CwcSIMVWiMyt_z9tRwi6WQ"
    }
    
    // Patch desabilitado - não aplicar automaticamente
    // Isso permite editar o código diretamente sem ser revertido
    // Para aplicar o patch manualmente, execute: aplicar-patch-manualmente.bat
    // Para atualizar o patch após edições, execute: atualizar-patch-apos-edicao.bat
    // tasks.whenTaskAdded { task ->
    //     if (task.name.contains("compile") || task.name.contains("assemble")) {
    //         task.dependsOn applyPatch
    //     }
    // }
    
    configurations.all {
        resolutionStrategy {
            // Mapbox Maps SDK 11.18.0 (compatível com Navigation SDK 3.18.0)
            force "com.mapbox.maps:android:11.18.0"
            force "com.mapbox.maps:android-core:11.18.0"
            force "com.mapbox.module:maps-telemetry:11.18.0"
            force "com.google.android.gms:play-services-location:21.0.1"
        }
        exclude group: "com.mapbox.maps", module: "android-ndk27"
        exclude group: "com.mapbox.maps", module: "android-core-ndk27"
        exclude group: "com.mapbox.module", module: "maps-telemetry-ndk27"
    }
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            // Caution! In production, you need to generate your own keystore file.
            // see https://reactnative.dev/docs/signed-apk-android.
            signingConfig signingConfigs.debug
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    // The version of react-native is set by the React Native Gradle Plugin
    implementation("com.facebook.react:react-android")
    
    // Dependências para navegação customizada (sem Mapbox Navigation SDK)
    implementation 'com.squareup.retrofit2:retrofit:2.9.0'
    implementation 'com.squareup.retrofit2:converter-gson:2.9.0'
    implementation 'com.google.android.gms:play-services-location:21.0.1'
    // Mapbox Maps SDK 11.18.0 (compatível com Navigation 3.18.0)
    implementation 'com.mapbox.maps:android:11.18.0'
    // Necessário para evitar crash (NoClassDefFoundError: com.mapbox.navigator.ElectronicHorizonOptions)
    // Força o artefato AAR (contém as classes) ao invés do JAR.
    implementation 'com.mapbox.navigator:dash-native:324.18.0@aar'

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
}

apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
apply from: "../../node_modules/react-native-vector-icons/fonts.gradle"

// Garantir ícones de radar em res/drawable antes do build
afterEvaluate {
    preBuild.dependsOn copyRadarIconsToDrawable
}
