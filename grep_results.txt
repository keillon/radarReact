38:      throw new Error("react-native-geolocation-service n√£o dispon√≠vel");
61:// TTS: carregar s√≥ no primeiro uso para evitar "Requiring unknown module 'undefined'" no startup
62:let TtsCache: any = undefined; // undefined = ainda n√£o tentou; null = tentou e falhou
69:    console.warn("react-native-tts n√£o est√° dispon√≠vel:", error);
93:// Fun√ß√£o para calcular dist√¢ncia entre dois pontos (Haversine)
101:  const œÜ1 = (lat1 * Math.PI) / 180;
102:  const œÜ2 = (lat2 * Math.PI) / 180;
103:  const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
104:  const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;
107:    Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
108:    Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
114:// Fun√ß√£o auxiliar para calcular dist√¢ncia ponto-reta (Cross-Track Distance)
125:// OTIMIZA√á√ÉO: Fun√ß√£o de filtro espacial (Grid) para evitar O(N*M)
127:const GRID_SIZE = 0.01; // ~1.1km por c√©lula
135:// Fun√ß√£o para checar se o radar est√° na rota de forma eficiente
146:  // OTIMIZA√á√ÉO: Checar apenas segmentos pr√≥ximos ao ponto do radar (Bounding Box simples)
147:  // Como agora o radar vem de um set j√° filtrado espacialmente na rota de forma global,
177:// Fun√ß√£o para calcular dist√¢ncia perpendicular de um ponto a um segmento de linha
209:// Fun√ß√£o para calcular dist√¢ncia de um ponto at√© a rota (dist√¢ncia perpendicular mais pr√≥xima)
215:    // Se n√£o h√° rota, retornar dist√¢ncia grande
221:  // Verificar dist√¢ncia perpendicular para cada segmento da rota
235:// --- L√≥gica robusta estilo Waze: dist√¢ncia ao longo da rota com proje√ß√£o cont√≠nua ---
237:/** Dist√¢ncias cumulativas desde o in√≠cio da rota (em metros). cumulative[0]=0, cumulative[i]=soma dos segmentos 0..i-1 */
254: * Projeta um ponto na rota e retorna a dist√¢ncia cumulativa (em metros) at√© essa proje√ß√£o.
255: * Usa proje√ß√£o no segmento mais pr√≥ximo (n√£o s√≥ v√©rtices).
296: * Dist√¢ncia ao longo da rota do usu√°rio at√© o radar (em metros).
297: * Positiva = radar √† frente; negativa ou zero = j√° passou.
298: * Estilo Waze: proje√ß√£o cont√≠nua + cumulativas.
316:  // Histerese 5m: marcar "passou" quando < 5m para evitar flicker por ru√≠do do GPS
324:/** Arredonda dist√¢ncia para m√∫ltiplo de 10m (ex.: 287 -> 290, 283 -> 280), m√≠nimo 0. */
330:// Fun√ß√£o OTIMIZADA para filtrar radares pr√≥ximos √† rota usando Indexa√ß√£o Espacial (Grid)
331:// O(N + M) ao inv√©s de O(N * M)
354:  // Usamos um grid de 0.01 (~1km), ent√£o apenas as c√©lulas vizinhas bastam
357:  // 2. Percorrer a rota e checar apenas c√©lulas do Grid afetadas (O(M))
361:    // Checar c√©lula atual e vizinhas (3x3 grid around point)
375:            // Filtro r√°pido de Bounding Box antes do c√°lculo de dist√¢ncia real
379:              // Se tivermos um pr√≥ximo ponto na rota, checamos dist√¢ncia ao segmento
391:                // √öltimo ponto da rota, checamos dist√¢ncia simples
406:  console.log(`‚è±Ô∏è Filtro de rota otimizado: ${endT - startT}ms para ${radars.length} radares e ${routePoints.length} pontos.`);
429:  // OTIMIZA√á√ÉO: VisibleRadars removido por solicita√ß√£o do usu√°rio.
431:  // pois o Cluster nativo e as camadas persistentes j√° garantem a fluidez.
438:  const [nearbyRadarIds, setNearbyRadarIds] = useState<Set<string>>(new Set()); // IDs dos radares pr√≥ximos para anima√ß√£o
460:    "reportado" | "fixo" | "m√≥vel" | "semaforo"
461:  >("m√≥vel");
480:    value: "reportado" | "fixo" | "m√≥vel" | "semaforo";
495:        value: "m√≥vel",
496:        label: "Radar M√≥vel",
501:        label: "Sem√°foro c/ Radar",
513:  const alertedRadarIds = useRef<Set<string>>(new Set()); // Rastrear radares j√° alertados (apenas uma vez)
514:  const passedRadarIds = useRef<Set<string>>(new Set()); // Rastrear radares que j√° foram passados
522:  const postPassTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null); // Timer para modal p√≥s-passagem
526:  const audioPlayerRef = useRef<any>(null); // Refer√™ncia para √°udio nativo do Android/iOS
527:  const isPlayingRadarSound = useRef(false); // Flag para controle de reprodu√ß√£o
528:  const [showingPassedRadar, setShowingPassedRadar] = useState(false); // Estado p√≥s-passagem
536:    // Configurar TTS se dispon√≠vel (aguardar inicializa√ß√£o do m√≥dulo nativo) ‚Äî carregado sob demanda
574:    // Limpar √°udio ao desmontar (n√£o precisa carregar nada, s√≥ limpar)
585:      // Parar qualquer √°udio que esteja tocando
601:            title: "Permiss√£o negada",
602:            message: "√â necess√°rio permitir acesso √† localiza√ß√£o para usar o app",
615:          console.log(`üìç Localiza√ß√£o obtida:`, loc);
617:          setOrigin(loc); // Origem sempre ser√° a localiza√ß√£o atual
619:          // Buscar radares imediatamente quando obt√©m localiza√ß√£o
623:                `‚úÖ ${nearbyRadars.length} radares encontrados na inicializa√ß√£o`
628:              console.error("Erro ao buscar radares na inicializa√ß√£o:", error);
632:          console.error("Erro ao obter localiza√ß√£o:", error);
642:      console.error("Erro ao solicitar permiss√£o:", error);
650:        title: "Localiza√ß√£o",
651:        message: "Aguardando localiza√ß√£o atual...",
661:        message: "Por favor, digite um endere√ßo de destino",
672:    // Anima√ß√£o de entrada do loading (simplificada)
680:      // Se j√° temos coordenadas de destino (selecionado do autocomplete), usar diretamente
681:      // Caso contr√°rio, fazer geocode do texto digitado
688:      // Buscar rota com instru√ß√µes (o SDK vai calcular a rota internamente, mas buscamos para obter os pontos para radares)
701:      // Limpar estado de radares para nova navega√ß√£o (cada viagem come√ßa "limpa")
707:      // Iniciar navega√ß√£o IMEDIATAMENTE (n√£o esperar radares)
710:      // NOVIDADE: Filtrar imediatamente os radares que j√° temos na mem√≥ria para mostrar algo instant√¢neo
726:      // Buscar radares em BACKGROUND (n√£o bloqueia navega√ß√£o)
732:          // Filtrar radares que est√£o realmente pr√≥ximos da rota
735:          // UNIR: Manter o que j√° temos localmente (especialmente reportes recentes) e adicionar os novos
749:            `‚úÖ ${filteredFromApi.length} radares da API injetados na lista (total filtrado)`
753:          // Fallback simples: usar localiza√ß√£o atual se busca falhar
764:              console.log(`‚úÖ ${filtered.length} radares (fallback)`);
772:      // Resetar anima√ß√£o em caso de erro
784:        message: error.message || "N√£o foi poss√≠vel calcular a rota. Verifique o endere√ßo digitado.",
793:  // Buscar radares quando a localiza√ß√£o muda (mapa normal)
797:    // Buscar radares pr√≥ximos √† localiza√ß√£o atual
806:        console.log(`‚úÖ ${nearbyRadars.length} radares encontrados pr√≥ximos`);
815:  // Monitorar localiza√ß√£o apenas quando n√£o est√° navegando (o SDK cuida durante navega√ß√£o)
833:        console.error("Erro ao monitorar localiza√ß√£o:", error);
865:  // Reportar radar na localiza√ß√£o atual (modal: velocidade + tipo).
866:  // Futuro: mesma l√≥gica pode ser usada para reportar acidentes, tr√¢nsito, etc. (estilo Waze) ‚Äî por ora s√≥ radar.
869:    type?: "reportado" | "fixo" | "m√≥vel" | "semaforo";
876:    // Valida√ß√£o: velocidade obrigat√≥ria e m√°ximo 120 km/h
878:      Alert.alert("Aten√ß√£o", "Por favor, selecione a velocidade do radar");
882:      Alert.alert("Aten√ß√£o", "A velocidade m√°xima permitida √© 120 km/h");
893:      console.log("üìç [Report] Iniciando reporte. Modo:", reportLocationMode);
898:          console.log("üìç [Report] USANDO PIN DO MAPA:", reportCoords);
900:          Alert.alert("Erro", "Por favor, selecione uma localiza√ß√£o no mapa primeiro");
905:        // Modo padr√£o: localiza√ß√£o atual
908:          console.log("üìç [Report] USANDO GPS ATUAL:", reportCoords);
910:          Alert.alert("Erro", "Sua localiza√ß√£o atual n√£o est√° dispon√≠vel. Tente marcar no mapa.");
917:        Alert.alert("Erro", "Localiza√ß√£o inv√°lida para o reporte.");
922:      console.log(`üì° [Report] Enviando para API: Tipo=${type}, Velocidade=${speedLimit}, Lat=${reportCoords.latitude}, Lon=${reportCoords.longitude}`);
924:      // OTIMIZA√á√ÉO: Reporte OTIMISTA (Instant√¢neo)
934:      setSuccessMessage("Radar reportado com sucesso! ‚úÖ\n\n obrigado por ajudar a melhorar o App!");
937:      // Auto-dismiss ap√≥s 4 segundos
946:      // 3. Resetar formul√°rio
948:      setReportRadarType("m√≥vel");
951:      // 4. Chamar API em background (n√£o bloquear UI)
958:        // Substituir o tempor√°rio pelo real se o ID mudou
967:        // Opcional: remover do mapa se falhar miseravelmente, mas melhor deixar vis√≠vel localmente
970:      return; // Sair mais cedo, o trabalho j√° foi feito de forma otimista
981:          "Servidor indispon√≠vel",
982:          "N√£o foi poss√≠vel reportar o radar. Verifique sua conex√£o e tente novamente."
989:        error.message || "N√£o foi poss√≠vel reportar o radar. Tente novamente."
1004:        console.log(`üîÑ ${recentRadars.length} novos radares sincronizados`);
1006:        // Adicionar novos radares √† lista
1017:        // Se estiver navegando, tamb√©m adicionar aos radares filtrados
1054:  // Iniciar sincroniza√ß√£o em tempo real quando come√ßar a navegar
1065:      // Parar sincroniza√ß√£o quando parar de navegar
1079:  // Carregar MapboxNavigation s√≥ quando entrar em navega√ß√£o (evita "Requiring unknown module 'undefined'" no bundle)
1089:      console.warn("MapboxNavigation n√£o dispon√≠vel:", e);
1093:  // Manter refs atualizados para o handler do Socket.IO (evitar closure obsoleta durante navega√ß√£o)
1097:  // Preparar radares para o MapboxNavigation (sempre calcular, mesmo quando n√£o est√° navegando)
1099:    // Usar lista COMPLETA por solicita√ß√£o do usu√°rio.
1110:  // WebSocket nativo: radares em tempo real para todos (mapa e navega√ß√£o), inclusive durante navega√ß√£o
1149:                `üì° WebSocket: Novo radar recebido durante ${isNavigatingRef.current ? "navega√ß√£o" : "mapa"
1157:                  return prev; // J√° existe, n√£o adicionar novamente
1162:              // Durante navega√ß√£o: filtrar pela rota e adicionar ao filteredRadars
1172:                    `‚úÖ Radar ${radar.id} est√° pr√≥ximo √† rota, adicionando ao filteredRadars`
1176:                      return prev; // J√° existe
1180:                      `üìä filteredRadars atualizado: ${updated.length} radares`
1186:                    `‚ö†Ô∏è Radar ${radar.id} n√£o est√° pr√≥ximo √† rota (dist√¢ncia > 100m)`
1190:                // N√£o est√° navegando: adicionar diretamente ao filteredRadars
1192:                  `‚úÖ Adicionando radar ao filteredRadars (n√£o est√° navegando)`
1196:                    return prev; // J√° existe
1211:              // console.log(`üì° WebSocket: Radar atualizado:`, radar.id);
1222:                  `üìä filteredRadars atualizado ap√≥s update: ${updated.length} radares`
1228:              // console.log(`üì° WebSocket: Radar deletado/inativado:`, radarId);
1234:                  `üóëÔ∏è Radar removido de radars: ${updated.length} radares restantes`
1241:                  `üóëÔ∏è Radar removido de filteredRadars: ${updated.length} radares restantes`
1246:              console.log("‚úÖ WebSocket conectado:", payload.message);
1277:        console.warn("WebSocket n√£o dispon√≠vel para alertas em tempo real:", e);
1292:  // Memoizar convers√£o de Set para Array para evitar nova refer√™ncia a cada render
1295:  // Handler para mudan√ßa de localiza√ß√£o (memoizado)
1297:    // Verifica√ß√£o de null para evitar NullPointerException
1309:      // Debounce de atualiza√ß√£o de localiza√ß√£o para evitar movimentos err√°ticos
1314:      // Aumentar debounce para 1 segundo para evitar atualiza√ß√µes muito frequentes
1322:          // S√≥ atualizar se a localiza√ß√£o mudou significativamente (mais de 20 metros)
1331:            // Se a dist√¢ncia for muito pequena (< 20m), n√£o atualizar
1336:            // Verificar se a mudan√ßa √© muito grande (poss√≠vel erro do GPS)
1337:            // Se mudou mais de 100m em menos de 2 segundos, provavelmente √© erro
1343:                "‚ö†Ô∏è Mudan√ßa de localiza√ß√£o muito grande, ignorando (poss√≠vel erro GPS)"
1352:          console.error("Erro ao processar localiza√ß√£o:", error);
1356:      // Buscar radares pr√≥ximos durante navega√ß√£o REMOVIDO por solicita√ß√£o
1360:      // Fun√ß√£o auxiliar para esconder modal com anima√ß√µes
1386:      // Verificar dist√¢ncia at√© cada radar e alertar (com debounce)
1449:              // J√° passou deste radar? Ignorar
1459:              // ‚úÖ CHECK 1: Radar deve estar EXATAMENTE na linha da rota (‚â§ 5m perpendicular)
1462:                // console.log(`‚ùå Radar ${radar.id} rejeitado - n√£o est√° na linha da rota`);
1463:                return; // Rejeitar - n√£o est√° na linha tra√ßada
1466:              // ‚úÖ CHECK 2: Dist√¢ncia perpendicular √† rota deve ser ‚â§ 5m
1473:                // console.log(`‚ùå Radar ${radar.id} rejeitado - ${routeDistance.toFixed(1)}m perpendicular (m√°x 5m)`);
1477:              // ‚úÖ CHECK 3: Calcular dist√¢ncia AO LONGO da rota (proje√ß√£o)
1484:              // Se j√° passou, marcar e ignorar
1487:                // console.log(`‚úÖ Radar ${radar.id} marcado como passado`);
1493:              // ‚úÖ CHECK 4: Radar deve estar √† frente (> 0m) e dentro do alcance de alerta (< 500m)
1495:                // console.log(`‚ùå Radar ${radar.id} rejeitado - ${distanceAlongRoute.toFixed(0)}m ao longo da rota (deve estar entre 0-500m)`);
1496:                return; // Muito longe ou atr√°s
1499:              // ‚úÖ CHECK 5: Selecionar o radar mais pr√≥ximo AO LONGO da rota
1501:                // console.log(`‚úÖ Radar ${radar.id} selecionado - ${distanceAlongRoute.toFixed(0)}m ao longo da rota, ${routeDistance.toFixed(1)}m perpendicular`);
1586:                          // Esconder modal ap√≥s 5 segundos
1591:                      // Guardar refer√™ncia para limpeza
1638:                  radarType = "Radar Semaf√≥rico";
1640:                  radarType = "Radar M√≥vel";
1651:                  message = `Aten√ß√£o! ${radarType} a ${Math.round(
1659:                  message = `Aten√ß√£o! ${radarType} muito pr√≥ximo`;
1664:                  message += `. Limite ${speedLimit} quil√¥metros por hora`;
1676:              // Controlar reprodu√ß√£o de som baseado na dist√¢ncia
1677:              // Usar TTS para fazer "beep" de alerta ao inv√©s de arquivo MP3
1679:                // Tocar som de alerta quando est√° entre 0m e 20m
1693:                      console.log('üîä Alerta sonoro de radar iniciado');
1703:                  console.log('üîá Alerta sonoro de radar parado');
1740:        console.log("Evento routeChanged sem geometria v√°lida:", event);
1744:      console.log("üõ£Ô∏è Rota recalculada! Atualizando radares...");
1748:        // O evento pode vir como string JSON (nossa convers√£o nativa) ou objeto direto
1749:        // Tentamos parsear se for string, sen√£o assumimos que √© objeto ou array
1751:          // Verificar se √© Polyline (n√£o come√ßa com { ou [) - Fallback se a convers√£o nativa falhou
1753:            console.warn("‚ö†Ô∏è Recebido Polyline em vez de GeoJSON. A convers√£o nativa pode ter falhado.");
1754:            // Aqui idealmente decodificar√≠amos Polyline no JS, mas melhor garantir o nativo.
1755:            // A modifica√ß√£o no MapboxNavigationView.kt deve garantir que isso venha como GeoJSON.
1800:      // Buscar radares pr√≥ximos ao novo caminho (usando API se necess√°rio ou cache local)
1809:      console.log(`‚úÖ ${filtered.length} radares encontrados na nova rota`);
1813:      // Atualizar lista principal tamb√©m para garantir consist√™ncia
1821:      console.error("Erro ao processar mudan√ßa de rota:", error);
1839:      message: "Voc√™ chegou ao destino!",
1875:      title: "Cancelar Navega√ß√£o",
1879:      cancelText: "N√£o",
1894:      console.error("Erro na navega√ß√£o:", error);
1898:        "Erro na navega√ß√£o";
1899:      setModalConfig({ visible: true, title: "Erro de Navega√ß√£o", message: errorMessage, type: "error" });
1901:      console.error("Erro ao processar erro de navega√ß√£o:", e);
1917:      // Pr√©-aquecer ou validar dados se necess√°rio
1922:  // Simplificado para evitar erros de renderiza√ß√£o
1988:      {/* Anima√ß√£o de loading durante prepara√ß√£o da navega√ß√£o */}
2007:            <Text style={styles.loadingText}>Preparando navega√ß√£o...</Text>
2017:              <Text style={styles.loadingText}>Erro ao carregar navega√ß√£o</Text>
2024:              {/* Bot√£o de reportar radar - abre modal com velocidade e tipo */}
2047:              <Text style={styles.loadingText}>Carregando navega√ß√£o...</Text>
2081:            `üéØ Renderizando modal: isNavigating=${isNavigating}, nearestRadar=${!!nearestRadar}, distance=${nearestRadar.distance
2113:                    ? "rgba(255,255,255,1)" // Transparente quando muito pr√≥ximo
2115:                      ? "rgba(255,255,255,1)" // Transparente quando pr√≥ximo
2145:                  if (type.includes("semaforo")) typeName = "Radar Semaf√≥rico";
2146:                  else if (type.includes("movel")) typeName = "Radar M√≥vel";
2150:                    ? `${typeName} Pr√≥ximo!`
2166:                        {" ‚Ä¢ "}
2187:          setReportRadarType("m√≥vel");
2218:              {reportStep === 1 && "O que voc√™ est√° vendo?"}
2220:              {reportStep === 3 && "Onde est√° localizado?"}
2226:              {reportStep === 3 && "Escolha a localiza√ß√£o"}
2321:                      Usar Localiza√ß√£o Atual
2368:                  <Text style={styles.reportModalCancelText}>‚Üê Voltar</Text>
2384:                  <Text style={styles.reportModalSubmitText}>Pr√≥ximo ‚Üí</Text>
2393:                    {isReportingRadar ? "Enviando..." : "‚úì Reportar"}
2417:                    console.log("üó∫Ô∏è [Home-MapPicker] Novo centro capturado:", coords);
2443:                      console.log("üó∫Ô∏è [Home-MapPicker] Confirmando localiza√ß√£o:", mapPickerCenter);
2449:                    <Text style={{ fontSize: 16, fontWeight: "600", color: "#fff" }}>Confirmar Localiza√ß√£o</Text>
2458:      {/* Modal: Erro ao obter localiza√ß√£o */}
2477:                Ops! Localiza√ß√£o Indispon√≠vel
2481:              N√£o conseguimos obter sua posi√ß√£o atual. Por favor, verifique se o seu GPS est√° ligado e tente novamente.
2525:      {/* Modal Customizado para Mensagens e Confirma√ß√µes */}
2570:                    <Text style={styles.customModalCancelButtonText}>{modalConfig.cancelText || "N√£o"}</Text>
2607:    // Acima do trip progress: quando o radar aparece a c√¢mera sobe e o trip progress fica embaixo
